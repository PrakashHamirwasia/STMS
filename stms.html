<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Location Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    .settings {
      background: #f8f9fa;
      padding: 20px 30px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .settings-row {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .settings label {
      font-weight: 600;
      color: #495057;
    }
    
    .settings input {
      padding: 10px 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }
    
    .settings button {
      padding: 10px 25px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .settings button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    
    .content {
      display: flex;
      height: 600px;
    }
    
    .sidebar {
      width: 350px;
      background: #f8f9fa;
      padding: 25px;
      overflow-y: auto;
      border-right: 2px solid #e9ecef;
    }
    
    .info-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .info-card h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-indicator.active {
      background: #28a745;
      box-shadow: 0 0 10px #28a745;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.inactive {
      background: #dc3545;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #6c757d;
      font-weight: 600;
    }
    
    .info-value {
      color: #212529;
      font-family: 'Courier New', monospace;
      font-weight: 500;
    }
    
    #map {
      flex: 1;
      height: 100%;
    }
    
    .alert {
      padding: 15px 20px;
      margin: 20px 30px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
        height: auto;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #e9ecef;
      }
      
      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìç ESP32 Real-Time Location Tracker</h1>
      <p>Monitor your device location in real-time</p>
    </div>
    
    <div class="settings">
      <div class="settings-row">
        <label for="esp32-ip">ESP32 IP Address:</label>
        <input type="text" id="esp32-ip" placeholder="e.g., 192.168.1.100" value="192.168.1.100">
        <button onclick="connectToESP32()">Connect</button>
        <button onclick="toggleTracking()" id="track-btn">Start Tracking</button>
      </div>
    </div>
    
    <div id="alert-container"></div>
    
    <div class="content">
      <div class="sidebar">
        <div class="info-card">
          <h3>
            <span class="status-indicator inactive" id="status"></span>
            Device Status
          </h3>
          <div class="info-row">
            <span class="info-label">Connection:</span>
            <span class="info-value" id="connection-status">Disconnected</span>
          </div>
          <div class="info-row">
            <span class="info-label">Last Update:</span>
            <span class="info-value" id="last-update">--</span>
          </div>
        </div>
        
        <div class="info-card">
          <h3>üìç Location Data</h3>
          <div class="info-row">
            <span class="info-label">Latitude:</span>
            <span class="info-value" id="latitude">--</span>
          </div>
          <div class="info-row">
            <span class="info-label">Longitude:</span>
            <span class="info-value" id="longitude">--</span>
          </div>
          <div class="info-row">
            <span class="info-label">Accuracy:</span>
            <span class="info-value" id="accuracy">--</span>
          </div>
        </div>
        
        <div class="info-card">
          <h3>üìä Statistics</h3>
          <div class="info-row">
            <span class="info-label">Total Updates:</span>
            <span class="info-value" id="update-count">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">Uptime:</span>
            <span class="info-value" id="uptime">--</span>
          </div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
  </div>

  <script>
    // Configuration
    let esp32IP = '';
    let isTracking = false;
    let updateInterval = null;
    let map = null;
    let marker = null;
    let circle = null;
    let updateCount = 0;
    let startTime = null;
    
    // Initialize map
    function initMap() {
      map = L.map('map').setView([21.2514, 81.6296], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
    }
    
    // Connect to ESP32
    function connectToESP32() {
      const ip = document.getElementById('esp32-ip').value.trim();
      
      if (!ip) {
        showAlert('Please enter ESP32 IP address', 'error');
        return;
      }
      
      esp32IP = ip.startsWith('http') ? ip : `http://${ip}`;
      
      // Test connection
      fetch(`${esp32IP}/location`)
        .then(response => response.json())
        .then(data => {
          showAlert('Successfully connected to ESP32!', 'success');
          document.getElementById('connection-status').textContent = 'Connected';
          updateLocation(data);
        })
        .catch(error => {
          showAlert('Failed to connect. Check IP address and ensure ESP32 is running.', 'error');
          console.error('Connection error:', error);
        });
    }
    
    // Toggle tracking
    function toggleTracking() {
      const btn = document.getElementById('track-btn');
      
      if (!esp32IP) {
        showAlert('Please connect to ESP32 first', 'error');
        return;
      }
      
      if (isTracking) {
        clearInterval(updateInterval);
        isTracking = false;
        btn.textContent = 'Start Tracking';
        btn.style.background = '#667eea';
      } else {
        startTime = Date.now();
        updateInterval = setInterval(fetchLocation, 2000);
        fetchLocation(); // Immediate fetch
        isTracking = true;
        btn.textContent = 'Stop Tracking';
        btn.style.background = '#dc3545';
      }
    }
    
    // Fetch location from ESP32
    function fetchLocation() {
      fetch(`${esp32IP}/location`)
        .then(response => response.json())
        .then(data => {
          updateLocation(data);
          document.getElementById('status').className = 'status-indicator active';
          document.getElementById('connection-status').textContent = 'Connected';
        })
        .catch(error => {
          document.getElementById('status').className = 'status-indicator inactive';
          document.getElementById('connection-status').textContent = 'Connection Lost';
          console.error('Fetch error:', error);
        });
    }
    
    // Update location on map and UI
    function updateLocation(data) {
      if (!data.valid || data.lat === 0 || data.lon === 0) {
        return;
      }
      
      updateCount++;
      
      // Update info display
      document.getElementById('latitude').textContent = data.lat.toFixed(6);
      document.getElementById('longitude').textContent = data.lon.toFixed(6);
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
      document.getElementById('update-count').textContent = updateCount;
      document.getElementById('accuracy').textContent = '¬± 100m';
      
      if (startTime) {
        const uptime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(uptime / 60);
        const seconds = uptime % 60;
        document.getElementById('uptime').textContent = `${minutes}m ${seconds}s`;
      }
      
      // Update map
      const latlng = [data.lat, data.lon];
      
      if (marker) {
        marker.setLatLng(latlng);
        circle.setLatLng(latlng);
      } else {
        marker = L.marker(latlng).addTo(map)
          .bindPopup(`<b>ESP32 Device</b><br>Lat: ${data.lat.toFixed(6)}<br>Lon: ${data.lon.toFixed(6)}`);
        
        circle = L.circle(latlng, {
          color: '#667eea',
          fillColor: '#667eea',
          fillOpacity: 0.2,
          radius: 100
        }).addTo(map);
        
        map.setView(latlng, 15);
      }
      
      marker.openPopup();
    }
    
    // Show alert messages
    function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      const alertClass = type === 'error' ? 'alert-error' : 'alert-warning';
      
      container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    // Initialize on page load
    window.onload = function() {
      initMap();
    };
  </script>
</body>
</html>